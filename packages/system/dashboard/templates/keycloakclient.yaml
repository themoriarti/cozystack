{{- $cozyConfig := lookup "v1" "ConfigMap" "cozy-system" "cozystack" }}
{{- $host := index $cozyConfig.data "root-host" }}
{{- $extraRedirectUris := splitList "," ((index $cozyConfig.data "extra-keycloak-redirect-uri-for-dashboard") | default "") }}

{{- $existingK8sSecret := lookup "v1" "Secret" .Release.Namespace "k8s-client" }}
{{- $existingDashboardSecret := lookup "v1" "Secret" .Release.Namespace "dashboard-client" }}

{{ $dashboardClient := "" }}
{{- if $existingDashboardSecret }}
  {{- $dashboardClient = index $existingDashboardSecret.data "client-secret-key" | b64dec }}
{{- else }}
  {{- $dashboardClient = randAlphaNum 32 }}
{{- end }}

{{- $existingAuthConfig := lookup "v1" "Secret" .Release.Namespace "dashboard-auth-config" }}
{{ $cookieSecret := "" }}
{{- if $existingAuthConfig }}
  {{- $cookieSecret = index $existingAuthConfig.data "cookieSecret" | b64dec }}
{{- else }}
  {{- $cookieSecret = randAlphaNum 16 }}
{{- end }}


---

apiVersion: v1
kind: Secret
metadata:
  name: dashboard-client
type: Opaque
data:
  client-secret-key: {{ $dashboardClient | b64enc }}

---

apiVersion: v1
kind: Secret
metadata:
  name: dashboard-auth-config
type: Opaque
data:
  cookieSecret: {{ $cookieSecret | b64enc }}



---

{{- if .Capabilities.APIVersions.Has "v1.edp.epam.com/v1" }}
---
apiVersion: v1.edp.epam.com/v1
kind: KeycloakClient
metadata:
  name: dashboard-client
spec:
  serviceAccount:
    enabled: true
  realmRef:
    name: keycloakrealm-cozy
    kind: ClusterKeycloakRealm
  secret: $dashboard-client:client-secret-key
  advancedProtocolMappers: true
  authorizationServicesEnabled: true
  name: dashboard
  clientId: dashboard
  directAccess: true
  public: false
  webUrl: "https://dashboard.{{ $host }}"
  defaultClientScopes:
    - groups
    - kubernetes-client
  redirectUris:
    - "https://dashboard.{{ $host }}/oauth2/callback/*"
    {{- range $i, $v := $extraRedirectUris }}
    - "{{ $v }}"
    {{- end }}
{{- end }}
